<!DOCTYPE html>
<html>
<head>
</head>
<body>
  Robots
  <pre id="robots"></pre>
  Markers
  <pre id="markers"></pre>
  Command
  <select id="type">
    <option value="1">Forward</option>
    <option value="2">Backward</option>
    <option value="3">Rotate (Clockwise)</option>
    <option value="4">Rotate (Counter Clockwise)</option>
  </select>
  <input type="text" id="duration" value="100"></input>
  <button class="ui basic button">Send</button>
  </br>

  <canvas id="canvas" width="1000" height="500"></canvas>
  <canvas id="panel" width="200" height="500"></canvas>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io.connect('http://localhost:4000/')

    $('.button').click((event) => {
      let type = $('#type').val()
      let duration = $('#duration').val()
      let command = { type: parseInt(type), duration: parseInt(duration) }
      console.log(command)
      socket.emit('send:command', command)
    })

    socket.on('robots:update', function (robots) {
      window.robots = robots
      $('#robots').text(JSON.stringify(robots))
    })

    socket.on('markers:update', function (markers) {
      window.markers = markers
      markers = markers.map((marker) => {
        return { x: Math.floor(marker.x), y: Math.floor(marker.y) }
      })
      $('#markers').text(JSON.stringify(markers))
    })

    socket.on('buffer', function (data) {
      window.rect = data.rect
      window.panel = data.panel

      show(data.buffer, 'canvas')
      show(data.bufferPanel, 'panel')
    })

    const show = (buffer, el) => {
      const canvas = document.getElementById(el)
      const context = canvas.getContext('2d')
      const img = new Image()
      const uint8Arr = new Uint8Array(buffer);
      const str = String.fromCharCode.apply(null, uint8Arr);
      const base64String = btoa(str);
      img.onload = function () {
        context.drawImage(this, 0, 0, canvas.width, canvas.height)
      }
      img.src = 'data:image/png;base64,' + base64String
    }

  </script>


</body>
</html>
